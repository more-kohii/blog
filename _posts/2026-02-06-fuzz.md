---
layout: post
title: |
    fuzz
date: 2026-02-06T17:37:00.000Z
categories: [iOS]
tags: []
---


VideoToolbox Fuzzer 구성 명세


VideoToolbox 퍼저는 VTDecoderXPCService → AppleGVA 하드웨어 디코더 공격 표면을 타깃으로 하며,
H.264 비트스트림을 syntax-aware하게 변형하는 입력 생성 + coverage-guided binary fuzzing 조합으로 구성합니다.

1. Target & Attack Surface

| Component              | Description               | Coverage Target                     | Known Bugs             |
| ---------------------- | ------------------------- | ----------------------------------- | ---------------------- |
| VTDecoderXPCService    | XPC 서비스로 비디오 디코딩 요청 처리    | VTDecodeFrame() → decoder init      | ZDI-24-1121 OOB read   |
| AppleGVA               | GPU Video Acceleration 모듈 | AppleGVA::DecodeSlice()             | CVE-2024-27804         |
| VideoToolbox.framework | libVideoToolbox.dylib     | VTDecompressionSessionDecodeFrame() | kernel write primitive |


Attack Vector: MP4 컨테이너 → H.264 비트스트림 → hardware decode path

1. Fuzzer Architecture

[Corpus Generator] ← h26forge (syntax-aware H.264 mutation)
↓
[Container Wrapper] ← minimp4 (H.264 → MP4)
↓
[Target Harness] ← vtdecode (Jackalope)
↓
[Coverage Monitor] ← AppleGVA 모듈 edge/trace

1. Input Generation Pipeline

3.1 Syntax-Aware Mutation (h26forge)


# Step 1: 정상 H.264 parse


./h26forge --json decode -i seed.264 -o seed.json


# Step 2: Syntax element mutation (Python)


{
"sps": {
"num_ref_frames": [1, 16, 300],  # ref list overflow
"offset_for_ref_frame": [0, 0xFFFFF]
},
"slice_header": {
"slice_type": [0,1,2,5,7,9],     # P/B/I/skip 등
"num_ref_idx_l0_active": [0,1,32]
}
}


# Step 3: Synthesize bitstream


./h26forge synthesize -i mutated.json -o fuzz.264


3.2 Containerization
minimp4 --annexb fuzz.264 --out fuzz.mp4  # Annex B → ISO BMFF


Corpus Size: 1000+ samples (normal + mutated variants)

1. Target Harness (Jackalope + vtdecode)

4.1 Build & Instrumentation


# Jackalope 빌드 (Sonoma 기준)


git clone [https://github.com/googleprojectzero/Jackalope](https://github.com/googleprojectzero/Jackalope)
cmake -DCMAKE_BUILD_TYPE=Release -DENABLE_LLVM_COVERAGE=ON ..


# vtdecode 컴파일 (VideoToolbox harness)


clang -finstrumentation-coverage -O2 vtdecode.c -framework VideoToolbox -o vtdecode


4.2 Fuzz Command
jackalope \
--target_bin=vtdecode \
--instrument_module=AppleGVA \
--target_func=_fuzz_entry \
--corpus_dir=./corpus \
--crash_dir=./crashes \
--timeout=10 \
--persistent


Persistent Mode: VTDecompressionSessionDecodeFrame() 반복 호출

1. Coverage Monitoring

| Metric        | Tool         | Threshold           |
| ------------- | ------------ | ------------------- |
| Edge Coverage | llvm-cov     | >80% AppleGVA edges |
| Trace Count   | afl-cov      | 1M+ unique traces   |
| Crash Triage  | ASan + drsan | UAF/overflow 우선     |


Sanitizers: ASan + UBSan + HWASan (kernel panic 모니터링)

1. Corpus Feedback Loop

Crash 분석 → GDB/LLDB로 리버스 →
h26forge mutation rule 추가 →
재생성 → Jackalope 재학습

1. Expected Outcomes

Short-term: ZDI-24 패턴 재현 (OOB read in slice parsing)
Medium-term: New heap overflow in ref frame management
Long-term: Sandbox escape → kernel primitive (CVE-2022-32939 유사)

1. Resources

h26forge: [github.com/h26forge/h26forge](http://github.com/h26forge/h26forge)
Jackalope: googleprojectzero/Jackalope
VideoToolbox Sonoma Guide: Jackalope VideoToolbox 예제
CVE References:

- ZDI-24-1121
- ZDI-24-1285
- CVE-2024-27804
논문: "Finding and Exploiting Vulnerabilities in H.264 Decoders"

---


VideoToolbox_Fuzzer_Spec.txt 로 저장하세요.

